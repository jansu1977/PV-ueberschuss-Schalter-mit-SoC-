blueprint:
  name: "PV Überschuss-Schalter mit SoC (Mehrfachgeräte)"
  description: >
    Schaltet eine oder mehrere Schalter-Entitäten EIN, wenn genügend PV-Überschuss
    vorhanden **und** der Batterie-SoC über einer frei wählbaren Schwelle liegt.
    Schaltet sie AUS, sobald eine der Bedingungen nicht mehr erfüllt ist.

    **Highlights**
    * Unterstützt **beliebig viele Shelly-Steckdosen oder andere Switches**
    * Alle Parameter bequem in der UI konfigurierbar (kein YAML nötig)
    * Minimaler Code, voll kompatibel mit Home-Assistant 2024.10+

  domain: automation
  input:
    target_switches:
      name: Ziel-Schalter (eine oder mehrere)
      selector:
        entity:
          domain: switch
          multiple: true
    surplus_sensor:
      name: PV-Überschuss-Sensor (W)
      selector:
        entity:
          domain: sensor
    battery_soc_sensor:
      name: Batterie-SoC-Sensor (%)
      selector:
        entity:
          domain: sensor
    min_soc:
      name: Mindest-SoC (%)
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
    min_surplus:
      name: Mindest-Überschuss (W)
      default: 500
      selector:
        number:
          min: 0
          max: 10000
          step: 50
          unit_of_measurement: "W"
          mode: slider

automation:
  trigger:
    - platform: state
      entity_id: !input surplus_sensor
    - platform: state
      entity_id: !input battery_soc_sensor

  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: !input battery_soc_sensor
              above: !input min_soc
            - condition: numeric_state
              entity_id: !input surplus_sensor
              above: !input min_surplus
          sequence:
            - service: switch.turn_on
              target:
                entity_id: !input target_switches
      default:
        - service: switch.turn_off
          target:
            entity_id: !input target_switches

  mode: restart

